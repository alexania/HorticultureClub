---
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'gatherings'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Format date
const formattedDate = entry.data.date.toLocaleDateString('en-ZA', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Create excerpt from content (first paragraph/sentence)
const excerptLength = 200;
const rawContent = entry.body || '';
const cleanText = rawContent
  .replace(/^---[\s\S]*?---/, '') // Remove frontmatter
  .replace(/#{1,6}\s/g, '') // Remove markdown headers
  .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
  .replace(/\*(.*?)\*/g, '$1') // Remove italic
  .replace(/`(.*?)`/g, '$1') // Remove inline code
  .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Remove links but keep text
  .trim();

const excerpt = cleanText.length > excerptLength 
  ? cleanText.substring(0, excerptLength).replace(/\s+\S*$/, '') + '...'
  : cleanText;
---

<div class="card-header">
  <img src={`${import.meta.env.BASE_URL}images/navigation/icons/icon_diaries.png`} alt="Gatherings" class="section-icon" />
  <h2 class="text-2xl font-medium text-cream m-0">Latest Gatherings</h2>
</div>

<div class="card-content">
  <article class="gathering-entry">
    <h3 class="mb-sm">
      <a 
        href={`./gatherings/${entry.slug}/`}
        class="text-3xl font-medium text-moss hover:text-forest-shadow transition-colors"
      >
        {entry.data.title}
      </a>
    </h3>
    
    <p class="gathering-meta text-sepia text-sm mb-sm italic">
      üìÖ {formattedDate} ‚Ä¢ 
      üìç {entry.data.location} ‚Ä¢ 
      ‚ú® {entry.data.attendees} Members
    </p>
    
    <!-- Gathering Images -->
    {entry.data.images && entry.data.images.length > 0 && (
      <div class="gathering-images flex gap-sm my-sm overflow-x-auto">
        {entry.data.images.slice(0, 2).map(image => {
          const imageSrc = image.src.replace(".png", "_small.png");
          const imageAlt = image.alt;
          const imageUrl = `${import.meta.env.BASE_URL}images/content/gatherings/${entry.slug}/${imageSrc}`;
          
          return (
            <div class="gathering-image-item flex-shrink-0 vintage-photo">
              <img 
                src={imageUrl}
                alt={imageAlt}
                class="w-[150px] h-[100px] object-cover object-[30%] border-4 border-parchment shadow-lg"
                loading="lazy"
              />
            </div>
          );
        })}
      </div>
    )}
    
    <!-- Excerpt -->
    <p class="mb-md text-charcoal leading-relaxed">
      {excerpt}
    </p>
    
    <!-- Activities/Rituals Performed -->
    {entry.data.rituals_performed && (
      <div class="activities-performed mt-md">
        <h4 class="text-sepia font-secondary mb-xs">Rituals Performed:</h4>
        <ul class="ritual-list list-none flex flex-wrap gap-sm">
          {entry.data.rituals_performed.map(ritual => (
            <li class="bg-parchment px-sm py-xs rounded-full text-sm border border-decorative">
              üî¨ {ritual}
            </li>
          ))}
        </ul>
      </div>
    )}
    
    <!-- Activities -->
    {entry.data.activities && (
      <div class="activities-performed mt-md">
        <h4 class="text-sepia font-secondary mb-xs">Activities:</h4>
        <ul class="ritual-list list-none flex flex-wrap gap-sm">
          {entry.data.activities.map(activity => (
            <li class="bg-sage/20 px-sm py-xs rounded-full text-sm border border-moss/30 capitalize">
              {activity.replace('_', ' ')}
            </li>
          ))}
        </ul>
      </div>
    )}
    
    <!-- Weather Conditions -->
    {entry.data.weather && (
      <div class="weather-conditions mt-md p-sm bg-autumn/10 border border-autumn/30 rounded">
        <p class="text-sm">
          <strong>Atmospheric Conditions:</strong> {entry.data.weather}
        </p>
      </div>
    )}
    
    <!-- Read More Link -->
    <div class="mt-md">
      <a 
        href={`./gatherings/${entry.slug}/`}
        class="inline-flex items-center text-moss hover:text-forest-shadow transition-colors font-medium"
      >
        Read Full Expedition Report
        <svg class="ml-1 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </a>
    </div>
  </article>
</div>