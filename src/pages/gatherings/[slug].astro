---
import { getCollection, getEntry } from 'astro:content';
import ContentLayout from '../../layouts/ContentLayout.astro';

// Generate all gathering pages
export async function getStaticPaths() {
  const gatheringEntries = await getCollection('gatherings');
  return gatheringEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Format date
const formattedDate = entry.data.date.toLocaleDateString('en-ZA', {
  year: 'numeric',
  month: 'long', 
  day: 'numeric'
});

const formattedTime = entry.data.date.toLocaleTimeString('en-ZA', {
  hour: '2-digit',
  minute: '2-digit'
});
---

<ContentLayout 
  title={entry.data.title}
  description={`Expedition report: ${entry.data.title} - A detailed account of our botanical gathering at ${entry.data.location}.`}
  image={`${import.meta.env.BASE_URL}images/gatherings/expedition-header.jpg`}
>
  <div class="container">
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb mb-lg">
      <div class="flex items-center gap-2 text-sm text-sepia">
        <a href="/" class="hover:text-moss transition-colors">Home</a>
        <span>‚Üí</span>
        <a href="/#diaries" class="hover:text-moss transition-colors">Gathering Diaries</a>
        <span>‚Üí</span>
        <span class="text-charcoal">{entry.data.title}</span>
      </div>
    </nav>

    <!-- Expedition Header -->
    <header class="expedition-header mb-xl">
      <div class="bg-gradient-to-br from-plum/10 to-cream border border-plum/30 rounded-lg p-lg">
        <div class="flex items-center gap-sm mb-md">
          <img src={`${import.meta.env.BASE_URL}images/navigation/icons/icon_diaries.png`} alt="Gathering Diaries" class="w-8 h-8 object-contain" />
          <span class="text-plum font-ui text-sm uppercase tracking-wider">Expedition Report</span>
          {entry.data.featured && (
            <span class="bg-brass text-cream px-2 py-1 rounded-full text-xs uppercase tracking-wide">Featured</span>
          )}
        </div>
        
        <h1 class="text-4xl font-heading text-charcoal mb-md text-shadow">
          {entry.data.title}
        </h1>
        
        <div class="expedition-meta grid grid-cols-1 md:grid-cols-3 gap-md text-sm mb-md">
          <div class="meta-group bg-cream/50 rounded p-sm">
            <div class="flex items-center gap-1 text-sepia mb-1">
              üìÖ <strong>Date & Time</strong>
            </div>
            <div>{formattedDate}</div>
            <div>{formattedTime}</div>
          </div>
          
          <div class="meta-group bg-cream/50 rounded p-sm">
            <div class="flex items-center gap-1 text-sepia mb-1">
              üìç <strong>Location</strong>
            </div>
            <div>{entry.data.location}</div>
            {entry.data.coordinates && (
              <div class="text-xs text-sepia mt-1">
                {entry.data.coordinates.lat.toFixed(4)}¬∞, {entry.data.coordinates.lng.toFixed(4)}¬∞
              </div>
            )}
          </div>
          
          <div class="meta-group bg-cream/50 rounded p-sm">
            <div class="flex items-center gap-1 text-sepia mb-1">
              ‚ú® <strong>Participants</strong>
            </div>
            <div>{entry.data.attendees} Society Members</div>
            {entry.data.weather && (
              <div class="text-xs text-sepia mt-1">Weather: {entry.data.weather}</div>
            )}
          </div>
        </div>

        <!-- Activities & Rituals -->
        <div class="expedition-highlights grid grid-cols-1 md:grid-cols-2 gap-md">
          {entry.data.activities && entry.data.activities.length > 0 && (
            <div class="highlight-group">
              <h3 class="text-moss font-secondary mb-2 flex items-center gap-1">
                üåø Activities Performed
              </h3>
              <div class="flex flex-wrap gap-1">
                {entry.data.activities.map(activity => (
                  <span class="bg-sage/20 text-forest-shadow px-2 py-1 rounded-full text-xs capitalize">
                    {activity.replace('_', ' ')}
                  </span>
                ))}
              </div>
            </div>
          )}
          
          {entry.data.rituals_performed && entry.data.rituals_performed.length > 0 && (
            <div class="highlight-group">
              <h3 class="text-plum font-secondary mb-2 flex items-center gap-1">
                üîÆ Rituals Performed
              </h3>
              <div class="flex flex-wrap gap-1">
                {entry.data.rituals_performed.map(ritual => (
                  <span class="bg-plum/20 text-plum px-2 py-1 rounded-full text-xs">
                    {ritual}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </header>

    <!-- Main Expedition Report -->
    <article class="expedition-content prose prose-lg max-w-none">
      <div class="bg-cream border border-decorative rounded-lg p-lg shadow-soft">
        <Content />
      </div>
    </article>

    <!-- Specimens Collected -->
    {entry.data.specimens_collected && entry.data.specimens_collected.length > 0 && (
      <aside class="specimens-collected mt-xl">
        <div class="bg-moss/10 border border-moss/30 rounded-lg p-lg">
          <h3 class="text-moss font-secondary mb-md flex items-center gap-2">
            üî¨ Specimens Collected
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-md">
            {entry.data.specimens_collected.map(specimen => (
              <div class="specimen-card bg-cream rounded border border-moss/20 p-sm">
                <em class="italic text-moss font-medium cursor-help" title="Click for botanical details">
                  {specimen}
                </em>
                <div class="specimen-details text-xs text-sepia mt-1">
                  Scientific specimen archived in Society collection
                </div>
              </div>
            ))}
          </div>
        </div>
      </aside>
    )}

    <!-- Member Reflections -->
    {entry.data.member_reflections && entry.data.member_reflections.length > 0 && (
      <section class="member-reflections mt-xl">
        <h3 class="text-2xl font-secondary text-charcoal mb-lg text-center">
          Member Reflections
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-lg">
          {entry.data.member_reflections.map(reflection => (
            <div class="reflection-card bg-parchment border border-decorative rounded-lg p-md">
              <div class="reflection-header mb-sm">
                <div class="member-name font-secondary text-plum text-lg">
                  {reflection.author}
                </div>
                <div class="member-rank text-sepia text-sm italic">
                  {reflection.rank}
                </div>
              </div>
              <blockquote class="reflection-text text-charcoal italic leading-relaxed border-l-4 border-plum pl-md">
                "{reflection.reflection}"
              </blockquote>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Expedition Gallery Placeholder -->
    {entry.data.images && entry.data.images.length > 0 && (
      <section class="expedition-gallery mt-xl">
        <h3 class="text-2xl font-secondary text-charcoal mb-lg text-center">
          Expedition Documentation
        </h3>
        <div class="gallery-grid grid grid-cols-1 md:grid-cols-3 gap-md">
          {entry.data.images.map((image, index) => (
            <div class="image-placeholder bg-gradient-to-br from-parchment to-sage border-2 border-dashed border-sepia rounded-lg h-48 flex items-center justify-center opacity-70">
              <div class="text-center">
                <div class="text-sepia text-sm mb-1">üì∏</div>
                <div class="text-sepia text-xs">
                  {image.replace('.jpg', '').replace('-', ' ').replace('_', ' ')}
                </div>
              </div>
            </div>
          ))}
        </div>
        <p class="text-center text-sepia text-sm italic mt-md">
          <em>Photographic documentation preserved in Society archives</em>
        </p>
      </section>
    )}

    <!-- Navigation -->
    <nav class="expedition-navigation mt-xl">
      <div class="bg-parchment border border-decorative rounded-lg p-lg">
        <h3 class="text-sepia font-secondary mb-md text-center">Continue Your Journey</h3>
        <div class="flex justify-between items-center">
          <a 
            href="/#diaries" 
            class="inline-flex items-center text-moss hover:text-forest-shadow transition-colors font-medium"
          >
            ‚Üê Back to Gathering Diaries
          </a>
          <div class="text-center">
            <p class="text-sm text-sepia italic">"Each expedition deepens our botanical wisdom"</p>
          </div>
          <a 
            href="/almanac/" 
            class="inline-flex items-center text-moss hover:text-forest-shadow transition-colors font-medium"
          >
            View Seasonal Almanac ‚Üí
          </a>
        </div>
      </div>
    </nav>
  </div>
</ContentLayout>

<style>
  /* Prose styling for expedition content */
  .expedition-content :global(h2) {
    @apply text-2xl font-secondary text-moss mt-lg mb-md border-b border-moss/30 pb-sm;
  }
  
  .expedition-content :global(h3) {
    @apply text-xl font-secondary text-sepia mt-md mb-sm;
  }
  
  .expedition-content :global(h4) {
    @apply text-lg font-secondary text-plum mt-md mb-sm;
  }
  
  .expedition-content :global(h5) {
    @apply text-base font-secondary text-moss mt-sm mb-xs font-medium;
  }
  
  .expedition-content :global(p) {
    @apply text-charcoal leading-relaxed mb-md;
  }
  
  .expedition-content :global(ul) {
    @apply list-none space-y-xs mb-md;
  }
  
  .expedition-content :global(ul li) {
    @apply flex items-start gap-xs text-charcoal;
  }
  
  .expedition-content :global(ul li::before) {
    content: '‚Ä¢';
    @apply flex-shrink-0 text-moss font-bold;
  }
  
  .expedition-content :global(ol) {
    @apply list-decimal list-inside space-y-xs mb-md text-charcoal;
  }
  
  .expedition-content :global(blockquote) {
    @apply border-l-4 border-plum bg-plum/10 p-md my-md italic text-plum rounded;
  }
  
  .expedition-content :global(blockquote p) {
    @apply mb-0;
  }
  
  .expedition-content :global(em) {
    @apply italic relative cursor-help;
  }
  
  .expedition-content :global(strong) {
    @apply font-medium text-moss;
  }
  
  .expedition-content :global(hr) {
    @apply border-moss/30 my-lg;
  }
  
  /* Special expedition content blocks */
  .expedition-content :global(.scientific-observations) {
    @apply bg-cream border border-decorative rounded p-md my-md;
  }
  
  .expedition-content :global(.mystical-significance) {
    @apply bg-plum/10 border border-plum/30 rounded p-md my-md;
  }
  
  .expedition-content :global(.ritual-elements) {
    @apply bg-brass/10 border border-brass/30 rounded p-md my-md;
  }
  
  /* Gallery hover effects */
  .image-placeholder {
    transition: all 0.3s ease;
  }
  
  .image-placeholder:hover {
    transform: translateY(-2px);
    box-shadow: theme('boxShadow.medium');
    opacity: 0.9;
  }
  
  /* Specimen cards */
  .specimen-card {
    transition: all 0.3s ease;
  }
  
  .specimen-card:hover {
    transform: translateY(-2px);
    box-shadow: theme('boxShadow.soft');
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    .expedition-meta {
      grid-template-columns: 1fr;
    }
    
    .expedition-highlights {
      grid-template-columns: 1fr;
    }
    
    .gallery-grid {
      grid-template-columns: 1fr;
    }
    
    .member-reflections .grid {
      grid-template-columns: 1fr;
    }
  }
</style>